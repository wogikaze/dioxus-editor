# 開発計画 (アウトライナー実装)

## ゴール

Dioxus v0.7 で実装するアウトライナーを再利用可能なコンポーネントとして完成させる。編集操作・折りたたみ・記法レンダリング・Undo-tree を含む主要機能を動作させ、TEST_SPEC.md のテストケースを段階的に満たす。

- ## アーキテクチャ概要

- クライアント主体の単一ページアプリとして構成し、エディタを独立コンポーネント化して他アプリへ組み込み可能にする。
- Core モデル（ドキュメント/ノード/キャレット/選択/Undo-tree）と View モデル（可視ノードリスト、折り畳み状態、装飾済みテキスト）を分離。
- コマンドドリブン設計：キー/クリック入力→コマンド→状態遷移→描画を明確化し、ショートカット差し替えやプラグイン拡張を容易にする。

## 主要コンポーネント

1. **core::document**: ノードモデル（id, indent, text, children 範囲, collapsed, meta）と階層操作（インデント変更、兄弟/親子移動、複製、折り畳み、可視ノード生成）。
2. **core::selection / caret**: キャレット位置・選択範囲の管理（ノードID + オフセット）、行頭/行末/単語単位移動、範囲拡張/縮小。
3. **core::history**: Undo-tree を保持する履歴管理。分岐切替を許容し、構造変更も完全復元。
4. **core::parser**: インライン/ブロック記法のトークナイザと AST（リンク、装飾、チェックボックス、コード/テーブル/LaTeX ブロック、メディア）。
5. **ui::editor**: 行ビュー（行番号、折り畳みボタン、バレット、テキスト入力）、折り畳み操作、現在行ハイライト、検索窓/コマンドパレット/補完パネル。
6. **ui::shortcuts**: 編集用とアウトライナー用のショートカットマッピング。選択範囲有無や IME 合成状態で分岐。
7. **ui::render**: マークアップ AST を VNode に変換し、リンク/メディア/LaTeX/コードのプレビューとクリック動作を提供。
8. **ui::input_helpers**: 括弧自動補完、リンク/タグ補完、クリップボード貼り付けの正規化。

- ## データ構造とアルゴリズム

- ノードツリーは深さ優先の Vec で保持し、`indent` で階層を表現（非連続インデントを許容）。ID は安定 UUID。
 - ノードツリーは深さ優先の Vec で保持し、`indent` で階層を表現（非連続インデントを許容）。`LineId` は整数（例: `u64`）として扱う（`docs/dev/03-model-and-lines.md` に合わせる）。
- 折り畳みは「可視ノードリスト」を生成して親が折り畳みなら子をスキップ。`ctrl+[number]` で閾値より深いノードに折り畳みフラグを設定。
- 行移動/複製はノードと子範囲のスライス操作で行う。
- Undo-tree はコマンド差分を履歴ノードとして蓄積し、分岐を保持したまま `undo/redo/branch_switch` を提供。
 - Undo-tree は Document のスナップショット（履歴ノード）を蓄積し、分岐を保持したまま `undo/redo/branch_switch` を提供（`docs/dev/09-undo-tree-and-history.md` に合わせる）。
- 検索と補完はインデックス（タグ/リンク名など）を簡易トライ or ハッシュで管理。

- ## 入力・ショートカット設計

- キーハンドラで修飾キーとキーコードを判定し、IME 合成中は編集ショートカットを抑止。
- 編集系（Enter/Backspace/矢印/Home/End/PgUp/PgDn/Ctrl+Z/Ctrl+Shift+Z/Ctrl+V）とアウトライナー系（Tab/Shift+Tab/Space/Backspace 行頭/Alt+矢印/Ctrl+矢印/Ctrl+Enter/Ctrl+Shift+A/Ctrl+[number]/Shift+Enter/Shift+Alt+Up/Down）をマップ。
- 選択範囲の有無で挙動を分岐し、複数行インデント変更や行複製をサポート。

- ## レンダリング/スタイル

- インデント幅は CSS 変数で調整し、`indent` 値を掛け算して左パディングに適用。飛び級インデントにも対応。
- 折り畳みアイコンは行番号右に配置し、親行 hover で表示。折り畳み時は右向き三角、展開時は下向き三角。
- 現在行/選択行ハイライト、バレット表示、リンク/メディア/LaTeX/コードブロック/テーブルのスタイルをユニット化してテーマ変更を容易に。
- 画像クリックで拡大、YouTube/LaTeX/コードブロックは適切な埋め込み/プレビューを提供。

- ## 拡張・埋め込みポイント

- 外部リンク/メディアハンドラをプロップで受け取り、開き方や埋め込み挙動を差し替え可能に。
- ストレージ I/F を抽象化（ファイル/クラウド/ローカルストレージ）し、ロード/保存を差し替え可能に。
- コマンドパレットに外部コマンドを追加できるプラグイン API を検討。テーマ/スタイルのオーバーライド用クラス名を提供。

- ## 検証計画 (静的)

- キーマッピング表を仕様と照合したユニットテストを用意し、コマンド→状態遷移を検証（Undo-tree 分岐含む）。
- パーサのスナップショットテストで記法とブロック構文を網羅。エスケープケースや壊れた閉じ括弧もテーブル駆動で検証。
- 折り畳み/階層移動/インデント操作のプロパティテストを実施し、可視ノード生成の正しさを確認。
- 大規模データのベンチ/負荷テスト（E-801/E-802）を CI で自動化。

## 進行ステップ

1. **基盤実装**: ドキュメントモデル、キャレット/選択、Undo-tree の骨格、可視ノード生成を実装。キーマップ/コマンドレイヤを整備。
2. **編集・構造操作**: 改行・削除・インデント/デインデント・行移動/複製・折り畳み（クリック/ショートカット）を接続し、E-101〜E-105, E-201〜E-207 を動かす。
3. **記法レンダリング**: インライン装飾/リンク/タグ/チェックボックス、ブロック（コード/テーブル/LaTeX）、メディア埋め込みを追加し、N/L/BK 系テストを通す。
4. **入力補助と検索**: 括弧補完、リンク/タグ補完、検索窓、コマンドパレット、IME ガードを実装し、A/E-401〜E-404, E-701〜E-703 を通す。
5. **Undo-tree/履歴強化**: 分岐の可視化・切替、構造変更の復元精度を高め、E-601〜E-603 を検証。
6. **E2E/パフォーマンス**: TEST_SPEC.md ベースの E2E を Playwright/Cypress で自動化し、巨大データと高速入力の耐性を測定。
7. **埋め込み I/F と仕上げ**: 外部 I/F/テーマの整理、アクセシビリティ/フォーカスリング調整、ドキュメント更新。

- ## リスクと対策

- **Undo-tree の分岐管理が複雑**: 履歴ノードのメモリ管理をユニットテストで早期検証。
- **IME とショートカットの衝突**: IME 合成状態を検出し、編集ショートカットを無効化するガードを導入。
- **巨大データでのパフォーマンス**: 可視ノードの仮想化と差分描画を優先して実装し、E-801/E-802 のテストで確認。
- **パーサの誤認識**: コードブロックやエスケープケースをテーブル駆動テストで網羅。
