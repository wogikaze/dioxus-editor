# 05-folding-and-visibility: 折りたたみ機能

## ゴール

- 「折りたたみ」仕様を満たす UI とロジックを実装する。
- F-01〜F-07 のテスト項目を満たす。

## 実装方針

- `Line` に `collapsed: bool` フラグを持たせる（すでに導入済み想定）。
- レンダリング時に「ある行が折りたたまれている場合、その行より深い indent をもつ後続行を非表示」にする。
- UI は以下を実装する:
  - 行番号横に折りたたみボタン（hover 時のみ表示）。
  - `Ctrl+Enter` で現在行の折りたたみトグル。
  - `Ctrl+Shift+A` で全体の折りたたみ/展開。
  - `Ctrl+数字` で階層指定表示。

## 手順

1. 折りたたみ状態の計算
   - レンダリング用に「表示行だけ」の `Vec<(Line, visible: bool)>` を作る。
   - 上から順に走査し、「ある行が `collapsed == true` なら、その行より indent が大きい後続行は `visible = false`」にする。
   - さらに別の同レベル行が現れたら折りたたみ範囲を終える。
   - **パフォーマンス注意:** 常に全行を再計算すると E-801/E-802 の巨大ドキュメントで描画が詰まるため、`Document` のバージョン番号と折りたたみトグルの世代カウンタを依存にした `use_memo` で「可視行リスト」をキャッシュする。折りたたみ/展開や Document 更新時だけメモを無効化する設計にしておく。

2. 折りたたみボタン UI（F-01〜F-03）
   - 子要素を持っていると判定できる行（次の行の indent が大きい）にだけボタンを表示。
   - hover 時だけボタンを表示するよう CSS クラスを定義。
   - ボタンのアイコンは `collapsed` に応じて `▶` / `▼` を切り替える。

3. ショートカットによる折りたたみ (F-04, F-05, F-06, F-07)
   - `Ctrl+Enter`: 現在行の `collapsed` をトグル。
   - 「配下の全階層を一括折りたたみ」は、現在行配下のすべての子行に対して `collapsed = true` を設定。
   - `Ctrl+Shift+A`: 全行の `collapsed` をまとめて true / false にする。
   - `Ctrl+[1-6]`: 指定より深い indent をもつ行をすべて折りたたむ（`collapsed = true` とする）実装とする。

4. E-201〜E-207 の折りたたみと編集の競合を意識した挙動設計
   - 親行を切り取った場合、折りたたみ状態に関わらず子要素もまとめて移動させる。
   - 折りたたみ中の検索、全削除などは後のステップで実装するが、データとして子要素が消えないことを先に保証する。

## Definition of Done

- 折りたたみボタンとショートカットで、期待通りに行が隠れたり表示されたりする。
- 折りたたんだ状態で編集しても、子要素のデータが壊れない。
